<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YAMADOG Mint</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
body {
  margin:0;
  font-family: monospace;
  background: linear-gradient(#7ccfff, #e9f8ff);
  min-height:100vh;
}

/* ‚ùÑÔ∏è SNOW */
.snow {
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:1;
}
.snow span {
  position:absolute;
  width:6px;height:6px;
  background:white;
  top:-10px;
  animation: fall linear infinite;
}
@keyframes fall { to { transform: translateY(110vh); } }

/* UI */
.container {
  position:relative;
  z-index:5;
  max-width:420px;
  margin:60px auto;
  background:white;
  border:6px solid black;
  padding:20px;
  text-align:center;
}

button {
  width:100%;
  padding:12px;
  margin-top:10px;
  font-size:16px;
  border:4px solid black;
  background:#f4c430;
  cursor:pointer;
}

button:disabled { opacity:.6; }

#spinner {
  display:none;
  width:24px;
  height:24px;
  border:4px solid black;
  border-top:4px solid transparent;
  margin:10px auto;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* MODAL */
#modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.modal-box {
  background:white;
  border:6px solid black;
  padding:16px;
  max-width:360px;
  width:90%;
  position:relative;
}
.close {
  position:absolute;
  right:8px;
  top:6px;
  cursor:pointer;
}
#nftImage svg {
  width:100%;
  border:4px solid black;
}
</style>
</head>

<body>

<div class="snow">
  <span style="left:10%;animation-duration:7s"></span>
  <span style="left:30%;animation-duration:9s"></span>
  <span style="left:50%;animation-duration:6s"></span>
  <span style="left:70%;animation-duration:10s"></span>
  <span style="left:90%;animation-duration:8s"></span>
</div>

<div class="container">
  <h1>üêï YAMADOG</h1>
  <div id="supply">Minted: -- / 5000</div>

  <button onclick="connectWallet()">Connect Wallet</button>
  <button id="mintBtn" onclick="mintNFT()" disabled>Mint (2000 YAMA)</button>

  <div id="spinner"></div>
  <div id="status"></div>

  <div style="margin-top:10px;font-size:12px">
    <a target="_blank" href="https://sepolia.etherscan.io/address/0x77CA6E72CdfA303E3Ee1065cd672DC73eB4EB88e">NFT</a><br>
    <a target="_blank" href="https://sepolia.etherscan.io/address/0xc9F6Ea476EBA9d82cdF88fE830642C0131bfA4c3">YAMA</a>
  </div>
</div>

<div id="modal">
  <div class="modal-box">
    <div class="close" onclick="modal.style.display='none'">‚úñ</div>
    <p>
      Congrats! You just give birth to your very own YAMADOG!<br>
      2000 YAMA burned forever üî•
    </p>
    <div id="tokenIdText"></div>
    <div id="nftImage"></div>
  </div>
</div>

<script>
const RPC = "https://eth-sepolia.g.alchemy.com/v2/GlVVBWhm9E9SWPmraQIlt";
const NFT_ADDR = "0x77CA6E72CdfA303E3Ee1065cd672DC73eB4EB88e";
const ERC20_ADDR = "0xc9F6Ea476EBA9d82cdF88fE830642C0131bfA4c3";
const PRICE = ethers.utils.parseUnits("2000",18);

const NFT_ABI = [
  "function mint()",
  "function totalSupply() view returns(uint256)",
  "function tokenURI(uint256)",
  "event Transfer(address indexed from,address indexed to,uint256 indexed tokenId)"
];
const ERC20_ABI = [
  "function allowance(address,address) view returns(uint256)",
  "function approve(address,uint256)"
];

let provider, signer, nft, erc20, user;
const modal = document.getElementById("modal");

async function connectWallet() {
  if (!window.ethereum) {
    alert("Open in MetaMask browser");
    return;
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  const net = await provider.getNetwork();
  if (net.chainId !== 11155111) {
    alert("Switch to Sepolia");
    return;
  }

  signer = provider.getSigner();
  user = await signer.getAddress();
  nft = new ethers.Contract(NFT_ADDR, NFT_ABI, signer);
  erc20 = new ethers.Contract(ERC20_ADDR, ERC20_ABI, signer);

  document.getElementById("mintBtn").disabled = false;
  document.getElementById("status").innerText = "Connected: " + user.slice(0,6)+"...";
}

async function mintNFT() {
  document.getElementById("spinner").style.display="block";

  const allowance = await erc20.allowance(user, NFT_ADDR);
  if (allowance.lt(PRICE)) {
    const txA = await erc20.approve(NFT_ADDR, PRICE);
    await txA.wait();
  }

  const tx = await nft.mint();
  const receipt = await tx.wait();

  const evt = receipt.events.find(e=>e.event==="Transfer");
  const tokenId = evt.args.tokenId.toString();

  const uri = await nft.tokenURI(tokenId);
  const svg = atob(uri.split(",")[1]);

  document.getElementById("tokenIdText").innerText = "Token ID: " + tokenId;
  document.getElementById("nftImage").innerHTML = svg;
  modal.style.display="flex";

  document.getElementById("spinner").style.display="none";
}
</script>

</body>
</html>
