<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YAMADOG Mint</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
* { box-sizing: border-box; font-family: monospace; }

body {
    margin: 0;
    background: linear-gradient(#79c9ff, #dff4ff);
    min-height: 100vh;
    overflow-x: hidden;
}

/* pixel overlay */
body::after {
    content:"";
    position:fixed;
    inset:0;
    background:repeating-linear-gradient(
        0deg,
        rgba(255,255,255,.06) 0,
        rgba(255,255,255,.06) 1px,
        transparent 1px,
        transparent 8px
    );
    pointer-events:none;
}

/* snow */
.snow { position:fixed; inset:0; pointer-events:none; }
.snow span {
    position:absolute;
    top:-10px;
    width:6px;
    height:6px;
    background:white;
    opacity:.8;
    animation:fall linear infinite;
}
@keyframes fall { to { transform:translateY(110vh); } }

.wrapper { max-width:420px; margin:60px auto; padding:20px; }

.card {
    background:white;
    border:6px solid #000;
    padding:20px;
    text-align:center;
}

button {
    width:100%;
    padding:12px;
    margin-top:10px;
    border:4px solid #000;
    background:#f4c430;
    font-size:16px;
    cursor:pointer;
}
button:disabled { opacity:.6; cursor:not-allowed; }

#status { font-size:13px; margin-top:8px; }

.spinner {
    margin:10px auto;
    width:24px;
    height:24px;
    border:4px solid #000;
    border-top:4px solid transparent;
    animation:spin .8s linear infinite;
    display:none;
}
@keyframes spin { to { transform:rotate(360deg); } }

.links { font-size:12px; margin-top:10px; }
.links a { color:black; display:block; }

.ground {
    position:fixed;
    bottom:0;
    width:100%;
    height:80px;
    background:#8b5a2b;
    border-top:6px solid #000;
}

#modal {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    display:none;
    align-items:center;
    justify-content:center;
}

.modal-box {
    background:white;
    border:6px solid #000;
    padding:16px;
    max-width:360px;
    width:90%;
    text-align:center;
    position:relative;
}

.close {
    position:absolute;
    right:8px;
    top:6px;
    cursor:pointer;
}

#nftImage svg {
    width:100%;
    border:4px solid #000;
    margin-top:10px;
}
</style>
</head>

<body>

<div class="snow">
  <span style="left:5%;animation-duration:7s"></span>
  <span style="left:15%;animation-duration:9s"></span>
  <span style="left:30%;animation-duration:6s"></span>
  <span style="left:45%;animation-duration:10s"></span>
  <span style="left:60%;animation-duration:8s"></span>
  <span style="left:75%;animation-duration:11s"></span>
  <span style="left:90%;animation-duration:7s"></span>
</div>

<div class="wrapper">
<div class="card">
    <h1>üêï YAMADOG</h1>
    <div id="supply">Minted: -- / 5000</div>

    <button id="connectBtn">Connect Wallet</button>
    <button id="mintBtn" disabled>Mint (2000 YAMA)</button>

    <div class="spinner" id="spinner"></div>
    <div id="status"></div>

    <div class="links">
        <a target="_blank" href="https://sepolia.etherscan.io/address/0x77CA6E72CdfA303E3Ee1065cd672DC73eB4EB88e">NFT Contract</a>
        <a target="_blank" href="https://sepolia.etherscan.io/address/0xc9F6Ea476EBA9d82cdF88fE830642C0131bfA4c3">YAMA Token</a>
    </div>
</div>
</div>

<div class="ground"></div>

<div id="modal">
<div class="modal-box">
    <div class="close" onclick="modal.style.display='none'">‚úñ</div>
    <p>
        Congrats! You just give birth to your very own YAMADOG!<br>
        You also burned 2000 YAMA forever üêïüî•
    </p>
    <div id="tokenIdText"></div>
    <div id="nftImage"></div>
    <div class="links" id="openseaLink"></div>
</div>
</div>

<script>
const RPC = "https://eth-sepolia.g.alchemy.com/v2/GlVVBWhm9E9SWPmraQIlt";
const NFT_ADDRESS = "0x77CA6E72CdfA303E3Ee1065cd672DC73eB4EB88e";
const ERC20_ADDRESS = "0xc9F6Ea476EBA9d82cdF88fE830642C0131bfA4c3";
const PRICE = ethers.utils.parseUnits("2000", 18);

const NFT_ABI = [
  "function mint()",
  "function totalSupply() view returns(uint256)",
  "function tokenURI(uint256) view returns(string)",
  "event Transfer(address indexed from,address indexed to,uint256 indexed tokenId)"
];
const ERC20_ABI = [
  "function allowance(address,address) view returns(uint256)",
  "function approve(address,uint256)"
];

const connectBtn = document.getElementById("connectBtn");
const mintBtn = document.getElementById("mintBtn");
const statusEl = document.getElementById("status");
const supplyEl = document.getElementById("supply");
const spinner = document.getElementById("spinner");
const modal = document.getElementById("modal");
const nftImage = document.getElementById("nftImage");

const readProvider = new ethers.providers.JsonRpcProvider(RPC);
const readNFT = new ethers.Contract(NFT_ADDRESS, NFT_ABI, readProvider);

let provider, signer, nft, erc20, user;

async function loadSupply() {
    const s = await readNFT.totalSupply();
    supplyEl.textContent = `Minted: ${s} / 5000`;
}
loadSupply();

connectBtn.onclick = async () => {
    if (!window.ethereum) {
        alert(
          "Mobile wallet not detected.\n\n" +
          "Open this site inside MetaMask or Trust Wallet browser."
        );
        return;
    }
    try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const net = await provider.getNetwork();
        if (net.chainId !== 11155111) {
            alert("Please switch to Ethereum Sepolia");
            return;
        }
        signer = provider.getSigner();
        user = await signer.getAddress();
        nft = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
        erc20 = new ethers.Contract(ERC20_ADDRESS, ERC20_ABI, signer);

        connectBtn.textContent = user.slice(0,6)+"..."+user.slice(-4);
        mintBtn.disabled = false;
        statusEl.textContent = "Wallet connected";
    } catch {
        statusEl.textContent = "Connection cancelled";
    }
};

mintBtn.onclick = async () => {
    try {
        spinner.style.display = "block";
        mintBtn.disabled = true;

        const allowance = await erc20.allowance(user, NFT_ADDRESS);
        if (allowance.lt(PRICE)) {
            statusEl.textContent = "Approving YAMA...";
            await (await erc20.approve(NFT_ADDRESS, PRICE)).wait();
        }

        statusEl.textContent = "Minting...";
        const tx = await nft.mint();
        const receipt = await tx.wait();

        const log = receipt.logs
            .map(l => { try { return nft.interface.parseLog(l); } catch { return null; } })
            .find(e => e && e.name==="Transfer" && e.args.from===ethers.constants.AddressZero);

        const tokenId = log.args.tokenId;
        const uri = await nft.tokenURI(tokenId);
        const json = JSON.parse(atob(uri.split(",")[1]));
        nftImage.innerHTML = atob(json.image.split(",")[1]);

        document.getElementById("tokenIdText").textContent = "Token ID #" + tokenId;
        document.getElementById("openseaLink").innerHTML =
          `<a target="_blank" href="https://testnets.opensea.io/assets/sepolia/${NFT_ADDRESS}/${tokenId}">
            View on OpenSea
           </a>`;

        modal.style.display = "flex";
        await loadSupply();
        statusEl.textContent = "Mint successful!";
    } catch (e) {
        console.error(e);
        statusEl.textContent = "Transaction failed";
    } finally {
        spinner.style.display = "none";
        mintBtn.disabled = false;
    }
};
</script>

</body>
</html>
