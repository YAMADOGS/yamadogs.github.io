<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YAMADOG Mint</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
* {
    box-sizing: border-box;
    font-family: monospace;
}

body {
    margin: 0;
    background: linear-gradient(#79c9ff, #dff4ff);
    min-height: 100vh;
    overflow-x: hidden;
}

/* PIXEL OVERLAY */
body::after {
    content: "";
    position: fixed;
    inset: 0;
    background-image: repeating-linear-gradient(
        0deg,
        rgba(255,255,255,0.06) 0,
        rgba(255,255,255,0.06) 1px,
        transparent 1px,
        transparent 8px
    );
    pointer-events: none;
}

/* ‚ùÑÔ∏è SNOW */
.snow {
    position: fixed;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
}

.snow span {
    position: absolute;
    top: -10px;
    width: 6px;
    height: 6px;
    background: white;
    animation: fall linear infinite;
    opacity: 0.8;
}

@keyframes fall {
    to {
        transform: translateY(110vh);
    }
}

.snow span:nth-child(n) {
    left: calc(100% * var(--i));
    animation-duration: calc(5s + var(--i) * 10s);
}

/* MAIN CARD */
.wrapper {
    max-width: 420px;
    margin: 60px auto;
    padding: 20px;
}

.card {
    background: #ffffff;
    border: 6px solid #000;
    padding: 20px;
    text-align: center;
}

h1 {
    margin-top: 0;
}

#supply {
    margin: 10px 0;
    font-weight: bold;
}

/* BUTTONS */
button {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: 4px solid #000;
    background: #f4c430;
    font-size: 16px;
    cursor: pointer;
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#status {
    margin-top: 10px;
    font-size: 13px;
}

/* SPINNER */
.spinner {
    margin: 10px auto;
    width: 24px;
    height: 24px;
    border: 4px solid #000;
    border-top: 4px solid transparent;
    animation: spin 0.8s linear infinite;
    display: none;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* LINKS */
.links {
    margin-top: 10px;
    font-size: 12px;
}

.links a {
    color: #000;
    text-decoration: underline;
    display: block;
}

/* GROUND */
.ground {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 80px;
    background: #8b5a2b;
    border-top: 6px solid #000;
}

/* MODAL */
#modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.modal-box {
    background: #fff;
    border: 6px solid #000;
    padding: 16px;
    max-width: 360px;
    width: 90%;
    position: relative;
    text-align: center;
}

.close {
    position: absolute;
    right: 8px;
    top: 6px;
    cursor: pointer;
    font-size: 18px;
}

.congrats {
    font-size: 13px;
    line-height: 1.4;
}

.tokenid {
    margin-top: 6px;
    font-weight: bold;
}

#nftImage svg {
    width: 100%;
    border: 4px solid #000;
    margin-top: 10px;
}
</style>
</head>

<body>

<!-- ‚ùÑÔ∏è Snow -->
<div class="snow">
    <span style="--i:0.05"></span><span style="--i:0.15"></span>
    <span style="--i:0.25"></span><span style="--i:0.35"></span>
    <span style="--i:0.45"></span><span style="--i:0.55"></span>
    <span style="--i:0.65"></span><span style="--i:0.75"></span>
    <span style="--i:0.85"></span><span style="--i:0.95"></span>
</div>

<div class="wrapper">
    <div class="card">
        <h1>üêï YAMADOG</h1>

        <div id="supply">Minted: -- / 5000</div>

        <button id="connectBtn">Connect Wallet</button>
        <button id="mintBtn" disabled>Mint (2000 YAMA)</button>

        <div class="spinner" id="spinner"></div>
        <div id="status"></div>

        <div class="links">
            <a href="https://sepolia.etherscan.io/address/0x77CA6E72CdfA303E3Ee1065cd672DC73eB4EB88e" target="_blank">
                View NFT Contract on Etherscan
            </a>
            <a href="https://sepolia.etherscan.io/address/0xc9F6Ea476EBA9d82cdF88fE830642C0131bfA4c3" target="_blank">
                View YAMA Token on Etherscan
            </a>
        </div>
    </div>
</div>

<div class="ground"></div>

<!-- SUCCESS MODAL -->
<div id="modal">
    <div class="modal-box">
        <div class="close" onclick="modal.style.display='none'">‚úñ</div>

        <div class="congrats">
            Congrats! You just give birth to your very own YAMADOG!<br>
            although you also burn your 2000 YAMA token out of the existance too bad.. for YAMAINU
        </div>

        <div class="tokenid" id="tokenIdText"></div>
        <div id="nftImage"></div>

        <div class="links" id="openseaLink"></div>
    </div>
</div>

<script>
const RPC_URL = "https://eth-sepolia.g.alchemy.com/v2/GlVVBWhm9E9SWPmraQIlt";
const NFT_ADDRESS = "0x77CA6E72CdfA303E3Ee1065cd672DC73eB4EB88e";
const ERC20_ADDRESS = "0xc9F6Ea476EBA9d82cdF88fE830642C0131bfA4c3";
const PRICE = ethers.utils.parseUnits("2000", 18);

const ERC20_ABI = [
    "function allowance(address,address) view returns(uint256)",
    "function approve(address,uint256) returns(bool)"
];

const NFT_ABI = [
    "function mint()",
    "function totalSupply() view returns(uint256)",
    "function tokenURI(uint256) view returns(string)",
    "event Transfer(address indexed from,address indexed to,uint256 indexed tokenId)"
];

const connectBtn = document.getElementById("connectBtn");
const mintBtn = document.getElementById("mintBtn");
const statusEl = document.getElementById("status");
const supplyEl = document.getElementById("supply");
const spinner = document.getElementById("spinner");
const modal = document.getElementById("modal");
const nftImage = document.getElementById("nftImage");

const readProvider = new ethers.providers.JsonRpcProvider(RPC_URL);
const readNFT = new ethers.Contract(NFT_ADDRESS, NFT_ABI, readProvider);

let provider, signer, user, nft, erc20;

function setStatus(msg) {
    statusEl.textContent = msg;
}

async function loadSupply() {
    try {
        const minted = await readNFT.totalSupply();
        supplyEl.textContent = `Minted: ${minted.toString()} / 5000`;
    } catch {
        supplyEl.textContent = "Minted: ? / 5000";
    }
}
loadSupply();

connectBtn.onclick = async () => {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const net = await provider.getNetwork();
    if (net.chainId !== 11155111) {
        alert("Switch to Ethereum Sepolia");
        return;
    }

    signer = provider.getSigner();
    user = await signer.getAddress();

    nft = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
    erc20 = new ethers.Contract(ERC20_ADDRESS, ERC20_ABI, signer);

    connectBtn.textContent = user.slice(0,6) + "..." + user.slice(-4);
    mintBtn.disabled = false;
    setStatus("Wallet connected");
};

mintBtn.onclick = async () => {
    try {
        spinner.style.display = "block";
        mintBtn.disabled = true;

        setStatus("Checking allowance...");
        const allowance = await erc20.allowance(user, NFT_ADDRESS);
        if (allowance.lt(PRICE)) {
            setStatus("Approving YAMA...");
            await (await erc20.approve(NFT_ADDRESS, PRICE)).wait();
        }

        setStatus("Minting...");
        const tx = await nft.mint();
        const receipt = await tx.wait();

        const event = receipt.logs
            .map(l => { try { return nft.interface.parseLog(l); } catch { return null; } })
            .find(e => e && e.name === "Transfer" && e.args.from === ethers.constants.AddressZero);

        const tokenId = event.args.tokenId;

        const uri = await nft.tokenURI(tokenId);
        const json = JSON.parse(atob(uri.split(",")[1]));
        nftImage.innerHTML = atob(json.image.split(",")[1]);

        document.getElementById("tokenIdText").textContent = "Token ID: #" + tokenId;
        document.getElementById("openseaLink").innerHTML =
            `<a target="_blank" href="https://testnets.opensea.io/assets/sepolia/${NFT_ADDRESS}/${tokenId}">
                View on OpenSea
            </a>`;

        modal.style.display = "flex";
        await loadSupply();
        setStatus("Mint successful!");
    } catch (e) {
        console.error(e);
        setStatus("Transaction failed");
    } finally {
        spinner.style.display = "none";
        mintBtn.disabled = false;
    }
};
</script>

</body>
</html>
